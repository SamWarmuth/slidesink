!!!
%head
  -@show = Slideshow.new if @show.nil?
  -@show.slides ||= []
  
  %script{:src => "/js/jquery-1.4.2.min.js", :type => "text/javascript"}  
  %script{:src => "/js/jquery-ui-1.8.4.custom.min.js", :type => "text/javascript"}
  %script{:src => "/js/showdown.js", :type => "text/javascript"}

  -if @show.new_document?
    %title SlideSink - New Show
  -else
    %title SlideSink - Edit #{@show.title}
  :css
    #{sass :style}
%body{:style => 'background: #ddd'}
  -if @show.new_document?
    %h1{:style => 'text-align: center'} New Show
  -else
    %h1{:style => 'text-align: center'} Edit #{@show.title}
  %form#basics{:action => "/edit", :method => "post", :style => 'width: 900px; margin: 20px auto; background: white; padding: 10px; border-radius: 5px;'}
    %input{:name => "show_id", :value => @show.id, :type => "hidden"}
    %p
      %label{:for => "title", :style => 'margin-left: 50px; margin-right: 15px'} Presentation Title
      %input#title.textfield{:name => "title", :type => "text", :value => @show.title, :style => "width: 180px"}
      %label{:for => "url", :style => "margin-left: 50px; margin-right: 15px"} URL
      %input#url.textfield{:name => "url", :type => "text", :value => @show.url, :style => "width: 150px"}
      %i{:style => "margin-left: 20px"} slidesink.com/your_url
  .guiedit{:style => "margin: 10px auto; width: 920px; height: 450px; position: relative;"}
    %div{:style => "position: absolute; top: 0; left: 858px; z-index: 100;"}
      #add-slide.awesome.green.large{:style => "width: 35px; height: 82px; padding-top: 62px; text-align: center; border-radius: 0 5px 5px 0; -webkit-box-shadow: none;"} New Slide
    #slide-list{:style => "white-space: nowrap; display: inline-block; width: 818px; height: 134px; margin-bottom: 10px; background: #BBB; position: relative; border-radius: 5px 0 0 5px; padding: 10px 20px; overflow: auto;"}
      -if @show.slides.empty?
        .slide-group{:style => "display: inline-block"}
          .tiny-slide
          .markdown{:style => "display: none", :name => "slide0"}
      -@show.slides.each_with_index do |slide, i|
        .slide-group{:style => "display: inline-block"}
          .tiny-slide!= slide.html
          .markdown{:style => "display: none", :name => "slide#{i}"} #{slide.markdown.gsub("\n", "LiNeBrEaK").to_s}
    %br
    
    %textarea#edit-field.tabarea{:style => "display: inline-block; font-size: 1em; font-family: monospace; width: 249px; height: 404px; padding: 10px; border: 1px solid #CCC; background: #eee; border-radius: 5px; margin-right: 5px; position: relative; top: 2px;"}
    
    .slide-viewer{:style => "display: inline-block; width: 640px; height: 424px; position: relative; padding: 0; margin: 0"}
      #active-slide.slide{:style => "margin: 0"}
      #active-mark{:style => "display: none"} Initial
      
          
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  %br
  .clear{:style => "clear: both;"}
  .buttons{:style => "width: 600px; margin: auto; text-align: center;"}
    %a#discard-changes.awesome.red.large{:href => "/show/#{@show.url}", :style => "display: inline-block; width: 175px;"} Discard Changes
    %a#save-changes.awesome.green.large{:href => "save", :style => "display: inline-block; width: 175px; margin-left: 20px"} Save Presentation
  %br
  %br
    
:javascript
  var showdown = new Showdown.converter();
  

  $(document).ready(function(){   
    $(".markdown").each(function(m){$(this).html($(this).html().replace(/LiNeBrEaK/g, "\n"))});
    var firstSlide = $(".tiny-slide").first();
    firstSlide.addClass("selected");
    $("#active-slide").html(firstSlide.html());
    $("#active-mark").html($('.tiny-slide.selected').siblings(".markdown").html());
    $("#edit-field").val($("#active-mark").html());      
    
    
    $("#add-slide").click(function(){
      $("#slide-list").append("<div class='slide-group' style='display: inline-block'><div class='tiny-slide'></div><div class='markdown' name='slide"+$(".markdown").size() +"' style='display: none'></div></div>");
      $(".tiny-slide").last().click();
      $("#edit-field").focus();
      
      return false;
    });
    
    $(".tiny-slide").live('click', function(){
      $(".tiny-slide").removeClass("selected");
      $(this).addClass("selected");
      $("#active-slide").html($(this).html());
      $("#active-mark").html($('.tiny-slide.selected').siblings(".markdown").html());
      $("#edit-field").val($("#active-mark").html());      
      $("#edit-field").focus();
    });
    
    $("#edit-field").keyup(function(){
      markdown = $(this).val();
      new_html = showdown.makeHtml(markdown)
      $("#active-slide").html(new_html);
      $(".tiny-slide.selected").html(new_html);
      
      $(".tiny-slide.selected").siblings(".markdown").html(markdown);
      $("#active-mark").html(markdown);
    });
    
    $("#save-changes").click(function(){
      // is this line still necessary?
      $(".tiny-slide.selected").siblings(".markdown").html($("#code-cover textarea").val());
          
      output = $.map($(".markdown"), function(m){return ($(m).attr('name')+"="+$(m).html())}).join("&").replace(/\n/g,"LiNeBrEaK");
      window.location = ("/save?"+$("#basics").serialize()+"&"+output);
      return false;
    });
    
    $(".tabarea").keydown(function(e){
      if (e.keyCode == 9){
        return false;
      }
    });
  });